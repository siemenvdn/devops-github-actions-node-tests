---
name: Rollout to Scaleway

#
# Trigger a rollout restart of all given deployments.
#

on:  # yamllint disable-line rule:truthy
  workflow_call:
    inputs:
      organization-id:
        description: Scaleway organization ID
        required: true
        type: string
      project-id:
        description: Scaleway project ID
        required: true
        type: string
      region:
        description: Target deployment region (such as nl-ams)
        required: true
        type: string
      cluster-id:
        description: Target cluster ID
        required: true
        type: string
      config-path:
        description: Path to configuration folder
        required: true
        type: string
    secrets:
      SCALEWAY_ACCESS_KEY:
        description: Scaleway API key ID
        required: true
      SCALEWAY_SECRET_KEY:
        description: Scaleway API key secret
        required: true

jobs:
  rollout:
    name: Rollout kubernetes config ${{ inputs.config-path }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Install scw tool
        uses: scaleway/action-scw@v0
        with:
          access-key: ${{ secrets.SCALEWAY_ACCESS_KEY }}
          secret-key: ${{ secrets.SCALEWAY_SECRET_KEY }}
          default-organization-id: ${{ inputs.organization-id }}
          default-project-id: ${{ inputs.project-id }}
          export-config: true
          save-config: true
      - name: Save Scaleway kubeconfig
        run: scw k8s kubeconfig install ${{ inputs.cluster-id }} region=${{ inputs.region }}
      - name: Apply config
        run: kubectl apply -k ${{ inputs.config-path }}
